---
author: 技术平台部
---
# 数据持久

## Spring Jdbc实现持久层开发

平台基于Spring JdbcTemplate，提供基础的BaseDAOJdbc实现

###  提供BaseDAOJdbc

- 获取JdbcDAO

```
  //获取JdbcDAO
   IBaseDAOJdbc jdbcDao = PersistentFactory.getJdbcDao();

   //通过指定的数据源获取JdbcDAO
   IBaseDAOJdbc jdbcDao = PersistentFactory.getJdbcDao("datasource1");
```


## JPA Repository开发

平台基于Spring Data JPA,并对其功能做了扩展，Spring Data JPA相关功能可以查看[相关文档](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/)


- 配置文件

```
#数据库配置
spring.datasource.url=jdbc:mysql://10.254.11.224:3306/duceap_20?characterEncoding=utf-8
spring.datasource.username=root
spring.datasource.password=root
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
```

```
#打印sql和开启日志
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
```

- Application

```java
@SpringBootApplication(scanBasePackages = "com.dragonsoft.*")
@EnableJpaRepositories(basePackages = "com.dragonsoft.*",repositoryFactoryBeanClass  = BaseRepositoryFactoryBean.class)
@PropertySource("classpath:application.properties")
@EntityScan(basePackages = "com.dragonsoft.*")
public class DbDemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(DbDemoApplication.class, args);
    }
}
```

- Entity

```java
@Entity
@EntityListeners({JpaAuditingEntityListener.class})
@Table(name = "t_test_user")
public class UserInfo implements Serializable {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id")
    private String id;

    @Column(name = "name")
    private String name;

    @Column(name = "Xb")
    private String Xb;

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String userName) {
        this.name = userName;
    }

    public String getXb() {
        return Xb;
    }

    public void setXb(String xb) {
        Xb = xb;
    }

    public UserInfo(String id, String name, String xb) {
        this.id = id;
        this.name = name;
        Xb = xb;
    }

    public UserInfo() {
    }
}

```


- Controller

```java
@RestController
@RequestMapping("/userTest")
public class JpaUserInfoController {

    @Autowired
    private JpaIUserInfoService jpaIUserInfoService;

    @RequestMapping(value = "findTestOne", method = RequestMethod.GET)
    public List<UserInfo> findAllUser(String id) {
        return jpaIUserInfoService.findAllUser(id);
    }

    @RequestMapping(value = "findTestTwo", method = RequestMethod.GET)
    public List<UserInfo> findAllUserByIds() {
        List<String> ids = new ArrayList<>();
        ids.add("1");
        ids.add("2");
        return jpaIUserInfoService.findAllUserByIds(ids);
    }

    @RequestMapping(value = "findTestThree", method = RequestMethod.GET)
    public List<UserInfo> findAllByIdIn() {
        return jpaIUserInfoService.findAllById("1");
    }
}

```

- Service

```java

public interface JpaIUserInfoService {

    List<UserInfo> findAllUser(String id);

    List<UserInfo> findAllUserByIds(List<String> ids);

    List<UserInfo> findAllById(String ids);
}

```

```java
@Service
public class JpaUserInfoService extends BaseService<UserInfo, String> implements JpaIUserInfoService {

    @Autowired
    private JpaUserInfoRepository jpaUserInfoRepository;

    @Override
    public List<UserInfo> findAllUser(String id) {
        return jpaUserInfoRepository.findAllUser(id);
    }

    @Override
    public List<UserInfo> findAllUserByIds(List<String> ids) {
        return   jpaUserInfoRepository.findAllUserByIds(ids);
    }

    @Override
    public List<UserInfo> findAllById(String ids) {
        return  jpaUserInfoRepository.findAllById(ids);
    }
}


```
- Repository

```java

@Repository
public interface JpaUserInfoRepository extends BaseRepository<UserInfo, String> {

    @Query(value = "select * from t_test_user where id=?1 ",nativeQuery = true)
    List<UserInfo> findAllUser(String id);

    @Query(value = "select * from t_test_user where id in (:ids) ",nativeQuery = true)
    List<UserInfo> findAllUserByIds(@Param("ids")List<String> ids);

    List<UserInfo> findAllById(String id);

}

```



## Mybatis Mapper开发


- 依赖POM文件

```
<dependency>
    <groupId>com.dragonsoft</groupId>
    <artifactId>duceap-boot-starter-mybatis</artifactId>
</dependency>
```



- 参数配置（可选）

```
#数据库配置
spring.datasource.url=jdbc:mysql://10.254.11.224:3306/duceap_20?characterEncoding=utf-8
spring.datasource.username=root
spring.datasource.password=root
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
#设置Mybatis Mapper文件存放路径，默认情况下存放resources/mapping/**/*Mapper.xml目录下
#mybatis-plus.mapper-locations=classpath:mapping/*Mapper.xml
#打开mybatis执行sql Debug日志
#logging.level.com.baomidou.mybatisplus=debug
#mybatis-plus.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl
```

- Application

```java
@SpringBootApplication(scanBasePackages = "com.dragonsoft.*")
@PropertySource("classpath:application.properties")
@EntityScan(basePackages = "com.dragonsoft.*")
@MapperScan("com.dragonsoft.**.mapper")
public class DbDemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(DbDemoApplication.class, args);
    }
}
```

- Entity

```java
//实体需加上TableName注解
@TableName(value = "t_test_user")
//@KeySequence("SEQ_TEST") 当采用Sequence时候，主键类型需要设计城INPUT
public class UserInfoMP implements Serializable {

    //主键注解
    @TableId(type = IdType.UUID)
    //@TableId(type = IdType.AUTO) 主键自增 数据库中需要设置主键自增
    //@TableId(type = IdType.NONE) 默认 跟随全局策略走
    //@TableId(type = IdType.UUID) UUID类型主键
    //@TableId(type = IdType.ID_WORKER) 数值类型  数据库中也必须是数值类型 否则会报错
    //@TableId(type = IdType.ID_WORKER_STR) 字符串类型   数据库也要保证一样字符类型
    //@TableId(type = IdType.INPUT) 用户自定义了  数据类型和数据库保持一致就行
    private String id;
    //可指定数据库字段、数据库类型等
//  @TableField(value = "NAME",jdbcType = JdbcType.VARCHAR)
    private String name;
    private String Xb;

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getXb() {
        return Xb;
    }

    public void setXb(String xb) {
        Xb = xb;
    }
}
```

- Controller

```java
@RestController
@RequestMapping("/userTest")
public class MybatisUserInfoController {

    @Autowired
    private MybatisIUserInfoService mybatisIUserInfoService;


    @RequestMapping(value = "findTestFour", method = RequestMethod.GET)
    public UserInfoMP findUserById(String id) {
        return mybatisIUserInfoService.findUserById(id);
    }

    @RequestMapping(value = "findTestFive", method = RequestMethod.GET)
    public List<UserInfoMP> selectByAnno() {
        String name = "xiao A";
        return mybatisIUserInfoService.selectByAnno(name);
    }

//    @RequestMapping(value = "findTestTwo", method = RequestMethod.GET)
//    public List<UserInfo> findAllUserByIds() {
//        List<String> ids = new ArrayList<>();
//        ids.add("1");
//        ids.add("2");
//        return jpaIUserInfoService.findAllUserByIds(ids);
//    }
//
//    @RequestMapping(value = "findTestThree", method = RequestMethod.GET)
//    public List<UserInfo> findAllByIdIn() {
//        return jpaIUserInfoService.findAllById("1");
//    }
}
```

- Service

```java
public interface MybatisIUserInfoService {

   UserInfoMP findUserById(String id);

   List<UserInfoMP> selectByAnno(String name);

 /*    List<UserInfoMP> findAllUserByIds(List<String> ids);

    List<UserInfoMP> findAllById(String ids);*/
}
```
```java
@Service
public class MybatisUserInfoService implements MybatisIUserInfoService {

    @Autowired
    private UserMapper userMapper;

    @Override
    public UserInfoMP findUserById(String id) {
        return userMapper.selectId(id);
    }

    @Override
    public List<UserInfoMP> selectByAnno(String name) {
        return userMapper.selectByAnno(name);
    }

/*    @Override
    public List<UserInfo> findAllUserByIds(List<String> ids) {
        return   jpaUserInfoRepository.findAllUserByIds(ids);
    }

    @Override
    public List<UserInfo> findAllById(String ids) {
        return  jpaUserInfoRepository.findAllById(ids);
    }*/
}

```

- Mapper

```java
@Mapper
public interface UserMapper<T> extends BaseMybatisMapper<UserInfoMP> {


    @Select("select * from t_test_user where id = #{id}")
    UserInfoMP selectId(String id);

    @Select("select * from t_test_user where name = #{name}")
    List<UserInfoMP> selectByAnno(String name);

    @Select(value = "select * from t_test_user where id in #{ids} ")
    List<UserInfo> findAllUserByIds(@Param("ids")List<String> ids);


/*    @Select("select * from t_user_test where name=#{arg0} and ${searchable.whereClause} ${searchable.orderClause}")
    List<UserInfoMP> paging(String name, @Param("searchable") Searchable searchable);

    @Select("select * from t_user_test where  ${searchable.whereClause} ${searchable.orderClause}")
    List<UserInfoMP> paging2(@Param("searchable") Searchable searchable);*/
}
```

