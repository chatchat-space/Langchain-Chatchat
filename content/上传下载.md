---
author: 技术平台部
---
# 上传下载


## uploader上传组件

> duceap uploader上传组件，结合前端的上传组件，支持database、filesystem、fastdfs三种存储方式

> 启用上传组件，系统将通过flyway自动建上传组件相关表


#### 上传过程说明

- 步骤一：调用/api/file/upload 上传接口([接口说明](http://127.0.0.1:3000/#/SDK%E4%B8%AD%E5%BF%83/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6/duceap_framework2.0/v2.2/API%E5%8F%82%E8%80%83/openApi?id=%e4%b8%8a%e4%bc%a0%e9%99%84%e4%bb%b6 "接口说明"))，将附件上传到指定位置（本地文件系统，数据库，fastDfs）,同时将上传记录保存至附件表t_uploader_file。

- 步骤二：将上传附件跟业务表关联。

- 前端框架已经对步骤一进行了封装，开发者只需要实现将附件关联业务表即可

- 操作场景：前端页面选择要上传的附件进行上传，进入步骤一，点击保存，进入步骤二，后端保存实体对象并且关联附件信息。上传步骤结束。

- 以下示例如何将附件关联业务表


### 1. 依赖POM

```
<dependency>
    <groupId>com.dragonsoft</groupId>
    <artifactId>duceap-boot-starter-uploader</artifactId>
</dependency>
```


### 2. 配置说明

三种存储方式分别示例

```java
#上传附件，支持如下存储策略：database、fileSystem、fastDfs ,默认database
duceap.uploader.store.strategy=database
#设置文件上传大小，springboot默认的最大上传大小是1MB
spring.servlet.multipart.max-file-size=150MB
spring.servlet.multipart.max-request-size=150MB
```

上传文件系统配置说明
```
duceap.uploader.store.strategy=fileSystem
//设置服务端存储路径
duceap.uploader.store.fileSystem.path=file:/D:/tmp/upload

```


采用fastDfs上传配置说明
```
duceap.uploader.store.strategy=fastDfs
//分组名 不同group之间数据互相隔离
duceap.uploader.store.fastDfs.groupName=group1
duceap.uploader.store.fastDfs.connect_timeout=2
duceap.uploader.store.fastDfs.network_timeout=30
duceap.uploader.store.fastDfs.charset=ISO8859-1
duceap.uploader.store.fastDfs.http.tracker_http_port=8080
//开启防盗链 默认否
duceap.uploader.store.fastDfs.http.anti_steal_token=false
//密钥
duceap.uploader.store.fastDfs.http.secret_key=FastDFS1234567890
duceap.uploader.store.fastDfs.tracker_server=192.168.10.8:22122

```

fastDfs连接池配置，根据项目实际情况调整

```
#连接池的大小 默认8
#duceap.uploader.store.fast-dfs.pool.max-total=8
#连接池中最大空闲的连接数,默认8
#duceap.uploader.store.fast-dfs.pool.max-idle=8

```

### 3. 基于UploadEntityHandler，依赖BaseRepository，实现上传附件保存（推荐）

实体类需实现UploaderListenable接口。

#### 3.1 Controller
```java
@RestController
@RequestMapping("/user")
public class UserCustomController {

    @Autowired
    IUserInfoService userInfoService;

    @RequestMapping(value = "file/saveOrUpdate", method = RequestMethod.POST)
    @ResponseBody
    public void saveOrUpdateFile(@RequestBody UserInfo userInfo) throws Exception {
        try {
            userInfoService.save(userInfo);
        } catch (Exception e) {
            throw new Exception("更新附件失败");
        }
    }

    @RequestMapping(value = "file/view/{userInfoId}", method = RequestMethod.GET)
    @ResponseBody
    public UserInfo view(@PathVariable("userInfoId") String userId) {
        UserInfo userInfo = userInfoService.findOne(userId);
        return userInfo;
    }

    @RequestMapping(value = "file/delete/{userInfoId}", method = RequestMethod.DELETE)
    @ResponseBody
    public void deleteFile(@PathVariable("userInfoId") String userInfoId) throws Exception {
        try {
            userInfoService.deleteById(id);
        }catch (Exception e){
            throw new Exception("删除附件失败");
        }
    }
 }

```

#### 3.2 Service(继承BaseService)

```java
@Service
@Transactional
public class UserInfoService extends BaseService<UserInfo, String> implements IUserInfoService {
    private UserInfoRepository userInfoRepository;

    public UserInfoService(UserInfoRepository userInfoRepository) {
        super(userInfoRepository);
        this.userInfoRepository = userInfoRepository;
    }

```

#### 3.3 Repository

```java
public interface UserInfoRepository extends BaseRepository<UserInfo,String> {

}
```

#### 3.4 Entity(实体需实现UploaderListenable接口，增加带@UploaderFile注解的FileHolder[]字段)

```java
@Entity
@Table(name = "T_USER_TEST")
public class UserInfo implements UploaderListenable,Serializable{
    @Id
    @GenericGenerator(name = "system-uuid", strategy = "uuid")
    @GeneratedValue(generator = "system-uuid")
    private String id;

    /**
     *
     * businessType: 附件业务类型，根据实际需要选择是否配置
     */
    @UploaderFile(businessType = "")
    @Transient
    private FileHolder[] fileHolders;

    //省略getter,setter

}


```


### 4. 采用UploadEntityHandler实现上传附件保存（推荐）

#### 4.1 Controller
```java
@RestController
@RequestMapping("/user")
public class UserCustomController {

    @Autowired
    IUserInfoService userInfoService;

    @RequestMapping(value = "file/saveOrUpdate", method = RequestMethod.POST)
    @ResponseBody
    public void saveOrUpdateFile(@RequestBody UserInfo userInfo) throws Exception {
        try {
            userInfoService.saveOrUpdate(userInfo);
        } catch (Exception e) {
            throw new Exception("更新附件失败");
        }
    }

    @RequestMapping(value = "file/view/{userInfoId}", method = RequestMethod.GET)
    @ResponseBody
    public UserInfo view(@PathVariable("userInfoId") String userId) {
        UserInfo userInfo = userInfoService.loadFile(userId);
        return userInfo;
    }

    @RequestMapping(value = "file/delete/{userInfoId}", method = RequestMethod.DELETE)
    @ResponseBody
    public void deleteFile(@PathVariable("userInfoId") String userInfoId) throws Exception {
        try
            userInfoService.deleteFile(userInfoId);
        }catch (Exception e){
            throw new Exception("删除附件失败");
        }
    }
 }

```

#### 4.2 Service

```java
@Service
@Transactional
public class UserInfoService extends BaseService<UserInfo, String> implements IUserInfoService {
    private UserInfoRepository userInfoRepository;

    public UserInfoService(UserInfoRepository userInfoRepository) {
        super(userInfoRepository);
        this.userInfoRepository = userInfoRepository;
    }

    @Autowired
    private UploadEntityHandler uploadEntityHandler;

    public void saveOrUpdate(UserInfo userInfo) {

       /*String fileIds = userInfo.getFileHolders() != null ?
       StringUtils.propertyJoin(Arrays.asList(userInfo.getFileHolders()), "id", ",") : "";
       //如果业务表存在管理附件关联字段 则需要设置业务关联的附件id
       userInfo.setFileId(fileIds);*/

       //新增当id 为null的情况会有问题，先更新业务表关联
       userInfoRepository.save(userInfo);

       //文件关联业务表
       uploadEntityHandler.saveFile(userInfo);

    }

    public UserInfo loadFile(String userInfoId) {
        UserInfo userInfo = findOne(userInfoId);
        return uploadEntityHandler.loadFile(userInfo);
    }

    public void deleteFile(String userInfoId) {
        UserInfo userInfo = loadFile(userInfoId);
        //删除附件
        uploadEntityHandler.deleteFile(userInfo);
    }

```

#### 4.3 Repository

```java
public interface UserInfoRepository extends BaseRepository<UserInfo,String> {

}
```

#### 4.4 Entity(实体需增加带@UploaderFile注解的FileHolder[]字段)

```java
@Entity
@Table(name = "T_USER_TEST")
public class UserInfo implements Serializable{
    @Id
    @GenericGenerator(name = "system-uuid", strategy = "uuid")
    @GeneratedValue(generator = "system-uuid")
    private String id;


    /**
     *
     * businessType: 附件业务类型，根据实际需要选择是否配置
     */
    @UploaderFile(businessType = "")
    @Transient
    private FileHolder[] fileHolders;

    //省略getter,setter

}


```


### 5. 采用UploadHandler实现上传附件保存(不依赖@UploaderFile注解)

#### 5.1 Controller

同 UploadEntityHandler方式

#### 5.2 Service

```java

//注入uploadhandler
@Autowired
private IUploadhandler uploadhandler;

//保存附件
public void saveOrUpdate(UserInfo userInfo) {
    /**String fileIds = userInfo.getFileHolders() != null ?
            StringUtils.propertyJoin(Arrays.asList(userInfo.getFileHolders()), "id", ",") : "";
    //业务表关联附件
    userInfo.setFileId(fileIds);**/

    userInfoRepository.save(userInfo);
    //保存附件 关联业务表
    String busiId = userInfo.getId();
    String busiType = "";
    FileHolder[] fileHolders = userInfo.getFileHolders();
    uploadhandler.saveOrUpdate(busiId, busiType, fileHolders);

}
//加载附件
public UserInfo loadFile(String userInfoId) {
    UserInfo userInfo = findOne(userInfoId);
    String businessId = userInfoId;
    String businessType = "";
    List<FileHolder> fileHolders = uploadhandler.queryByBusiId(businessId, businessType);
    userInfo.setFileHolders(fileHolders.toArray(new FileHolder[]{}));
    return userInfo;
}
//删除附件
public void deleteFile(String userInfoId) {
    //删除附件
    String businessId = userInfoId;
    String businessType = "";
    List<FileHolder> fileHolders = uploadhandler.queryByBusiId(businessId, businessType);
    uploadhandler.deleteInBatch(fileHolders.toArray(new FileHolder[]{}));

}

```

#### 5.3 Repository

同 UploadEntityHandler方式

#### 5.4 Entity(实体需增加FileHolder[]字段,无需@UploaderFile注解)

```java
@Entity
@Table(name = "T_USER_TEST")
public class UserInfo implements Serializable{
    @Id
    @GenericGenerator(name = "system-uuid", strategy = "uuid")
    @GeneratedValue(generator = "system-uuid")
    private String id;

    @Transient
    private FileHolder[] fileHolders;

    //省略getter,setter

}
```




