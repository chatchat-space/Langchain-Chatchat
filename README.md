# åŸºäºæœ¬åœ°çŸ¥è¯†çš„ ChatGLM åº”ç”¨å®ç°

## ä»‹ç»

ğŸŒ [_READ THIS IN ENGLISH_](README_en.md)

ğŸ¤–ï¸ ä¸€ç§åˆ©ç”¨ [ChatGLM-6B](https://github.com/THUDM/ChatGLM-6B) + [langchain](https://github.com/hwchase17/langchain) å®ç°çš„åŸºäºæœ¬åœ°çŸ¥è¯†çš„ ChatGLM åº”ç”¨ã€‚

ğŸ’¡ å— [GanymedeNil](https://github.com/GanymedeNil) çš„é¡¹ç›® [document.ai](https://github.com/GanymedeNil/document.ai) å’Œ [AlexZhangji](https://github.com/AlexZhangji) åˆ›å»ºçš„ [ChatGLM-6B Pull Request](https://github.com/THUDM/ChatGLM-6B/pull/216) å¯å‘ï¼Œå»ºç«‹äº†å…¨éƒ¨åŸºäºå¼€æºæ¨¡å‹å®ç°çš„æœ¬åœ°çŸ¥è¯†é—®ç­”åº”ç”¨ã€‚

âœ… æœ¬é¡¹ç›®ä¸­ Embedding é€‰ç”¨çš„æ˜¯ [GanymedeNil/text2vec-large-chinese](https://huggingface.co/GanymedeNil/text2vec-large-chinese/tree/main)ï¼ŒLLM é€‰ç”¨çš„æ˜¯ [ChatGLM-6B](https://github.com/THUDM/ChatGLM-6B)ã€‚ä¾æ‰˜ä¸Šè¿°æ¨¡å‹ï¼Œæœ¬é¡¹ç›®å¯å®ç°å…¨éƒ¨ä½¿ç”¨**å¼€æº**æ¨¡å‹**ç¦»çº¿ç§æœ‰éƒ¨ç½²**ã€‚


## æ›´æ–°ä¿¡æ¯

**[2023/04/07]** 
1. è§£å†³åŠ è½½ ChatGLM æ¨¡å‹æ—¶å‘ç”Ÿæ˜¾å­˜å ç”¨ä¸ºåŒå€çš„é—®é¢˜ (æ„Ÿè°¢ [@suc16](https://github.com/suc16) å’Œ [@myml](https://github.com/myml)) ï¼›
2. æ–°å¢æ¸…ç†æ˜¾å­˜æœºåˆ¶ï¼›
3. æ–°å¢`nghuyong/ernie-3.0-nano-zh`å’Œ`nghuyong/ernie-3.0-base-zh`ä½œä¸º Embedding æ¨¡å‹å¤‡é€‰é¡¹ï¼Œç›¸æ¯”`GanymedeNil/text2vec-large-chinese`å ç”¨æ˜¾å­˜èµ„æºæ›´å°‘ (æ„Ÿè°¢ [@lastrei](https://github.com/lastrei))ã€‚

**[2023/04/09]**
1. ä½¿ç”¨`langchain`ä¸­çš„`RetrievalQA`æ›¿ä»£ä¹‹å‰é€‰ç”¨çš„`ChatVectorDBChain`ï¼Œæ›¿æ¢åå¯ä»¥æœ‰æ•ˆå‡å°‘æé—® 2-3 æ¬¡åå› æ˜¾å­˜ä¸è¶³è€Œåœæ­¢è¿è¡Œçš„é—®é¢˜ï¼›
2. åœ¨`knowledge_based_chatglm.py`ä¸­å¢åŠ `EMBEDDING_MODEL`ã€`VECTOR_SEARCH_TOP_K`ã€`LLM_MODEL`ã€`LLM_HISTORY_LEN`ã€`REPLY_WITH_SOURCE`å‚æ•°å€¼è®¾ç½®ï¼›
3. å¢åŠ  GPU æ˜¾å­˜éœ€æ±‚æ›´å°çš„`chatglm-6b-int4`ã€`chatglm-6b-int4-qe`ä½œä¸º LLM æ¨¡å‹å¤‡é€‰é¡¹ï¼›
4. æ›´æ­£`README.md`ä¸­çš„ä»£ç é”™è¯¯ï¼ˆæ„Ÿè°¢ [@calcitem](https://github.com/calcitem)ï¼‰ã€‚

**[2023/04/11]** 
1. åŠ å…¥ Web UI V0.1 ç‰ˆæœ¬ã€‚


## ä½¿ç”¨æ–¹å¼

### ç¡¬ä»¶éœ€æ±‚
- ChatGLM-6B æ¨¡å‹ç¡¬ä»¶éœ€æ±‚
    
    | **é‡åŒ–ç­‰çº§**   | **æœ€ä½ GPU æ˜¾å­˜**ï¼ˆæ¨ç†ï¼‰ | **æœ€ä½ GPU æ˜¾å­˜**ï¼ˆé«˜æ•ˆå‚æ•°å¾®è°ƒï¼‰ |
    | -------------- | ------------------------- | --------------------------------- |
    | FP16ï¼ˆæ— é‡åŒ–ï¼‰ | 13 GB                     | 14 GB                             |
    | INT8           | 8 GB                     | 9 GB                             |
    | INT4           | 6 GB                      | 7 GB                              |

- Embedding æ¨¡å‹ç¡¬ä»¶éœ€æ±‚

    æœ¬é¡¹ç›®ä¸­é»˜è®¤é€‰ç”¨çš„ Embedding æ¨¡å‹ [GanymedeNil/text2vec-large-chinese](https://huggingface.co/GanymedeNil/text2vec-large-chinese/tree/main) çº¦å ç”¨æ˜¾å­˜ 3GBï¼Œä¹Ÿå¯ä¿®æ”¹ä¸ºåœ¨ CPU ä¸­è¿è¡Œã€‚
### è½¯ä»¶éœ€æ±‚
æœ¬é¡¹ç›®å·²åœ¨ python 3.8 ç¯å¢ƒä¸‹å®Œæˆæµ‹è¯•ã€‚
### 1. å®‰è£… python ä¾èµ–åŒ…
```commandline
pip install -r requirements.txt
```
æ³¨ï¼šä½¿ç”¨ langchain.document_loaders.UnstructuredFileLoader è¿›è¡Œéç»“æ„åŒ–æ–‡ä»¶æ¥å…¥æ—¶ï¼Œå¯èƒ½éœ€è¦ä¾æ®æ–‡æ¡£è¿›è¡Œå…¶ä»–ä¾èµ–åŒ…çš„å®‰è£…ï¼Œè¯·å‚è€ƒ [langchain æ–‡æ¡£](https://python.langchain.com/en/latest/modules/indexes/document_loaders/examples/unstructured_file.html)

### 2. æ‰§è¡Œè„šæœ¬ä½“éªŒ Web UI æˆ–å‘½ä»¤è¡Œäº¤äº’
æ‰§è¡Œ [webui.py](webui.py) è„šæœ¬ä½“éªŒ **Web äº¤äº’** <img src="https://img.shields.io/badge/Version-0.1-brightgreen">
```commandline
python webui.py
```
æ‰§è¡Œåæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![webui](./img/ui1.png)
Web UI ä¸­æä¾›çš„ API æ¥å£å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![webui](./img/ui2.png)
Web UI å¯ä»¥å®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š
1. è‡ªåŠ¨è¯»å–`knowledge_based_chatglm.py`ä¸­`LLM`åŠ`embedding`æ¨¡å‹æšä¸¾ï¼Œé€‰æ‹©åç‚¹å‡»`setting`è¿›è¡Œæ¨¡å‹åŠ è½½ï¼Œå¯éšæ—¶åˆ‡æ¢æ¨¡å‹è¿›è¡Œæµ‹è¯•
2. å¯æ‰‹åŠ¨è°ƒèŠ‚ä¿ç•™å¯¹è¯å†å²é•¿åº¦ï¼Œå¯æ ¹æ®æ˜¾å­˜å¤§å°è‡ªè¡Œè°ƒèŠ‚
3. æ·»åŠ ä¸Šä¼ æ–‡ä»¶åŠŸèƒ½ï¼Œé€šè¿‡ä¸‹æ‹‰æ¡†é€‰æ‹©å·²ä¸Šä¼ çš„æ–‡ä»¶ï¼Œç‚¹å‡»`loading`åŠ è½½æ–‡ä»¶ï¼Œè¿‡ç¨‹ä¸­å¯éšæ—¶æ›´æ¢åŠ è½½çš„æ–‡ä»¶
4. åº•éƒ¨æ·»åŠ `use via API`å¯å¯¹æ¥åˆ°è‡ªå·±ç³»ç»Ÿ

æˆ–æ‰§è¡Œ [knowledge_based_chatglm.py](knowledge_based_chatglm.py) è„šæœ¬ä½“éªŒ**å‘½ä»¤è¡Œäº¤äº’**
```commandline
python knowledge_based_chatglm.py
```


### å·²çŸ¥é—®é¢˜
- ç›®å‰å·²æµ‹è¯•æ”¯æŒ txtã€docxã€md æ ¼å¼æ–‡ä»¶ï¼Œæ›´å¤šæ–‡ä»¶æ ¼å¼è¯·å‚è€ƒ [langchain æ–‡æ¡£](https://python.langchain.com/en/latest/modules/indexes/document_loaders/examples/unstructured_file.html)ï¼Œç›®å‰å·²çŸ¥æ–‡æ¡£ä¸­è‹¥å«æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œå¯èƒ½å­˜åœ¨æ–‡ä»¶æ— æ³•åŠ è½½çš„é—®é¢˜ï¼›
- ä½¿ç”¨ macOS è¿è¡Œæœ¬é¡¹ç›®æ—¶ï¼Œå¯èƒ½å› ä¸º macOS ç‰ˆæœ¬ä¸º 13.3 åŠä»¥ä¸Šç‰ˆæœ¬å¯¼è‡´ä¸ pytorch ä¸å…¼å®¹ï¼Œæ— æ³•æ­£å¸¸è¿è¡Œçš„æƒ…å†µã€‚

### å¸¸è§é—®é¢˜

Q: `Resource punkt not found.` å¦‚ä½•è§£å†³ï¼Ÿ

A: https://github.com/nltk/nltk_data/raw/gh-pages/packages/tokenizers/punkt.zip ä¸­çš„ `packages/tokenizers` è§£å‹ï¼Œæ”¾åˆ°  `Searched in:` å¯¹åº”ç›®å½•ä¸‹ã€‚

Q: `Resource averaged_perceptron_tagger not found.` å¦‚ä½•è§£å†³ï¼Ÿ

A: å°† https://github.com/nltk/nltk_data/blob/gh-pages/packages/taggers/averaged_perceptron_tagger.zip ä¸‹è½½ï¼Œè§£å‹æ”¾åˆ° `Searched in:` å¯¹åº”ç›®å½•ä¸‹ã€‚

## DEMO

ä»¥é—®é¢˜`chatglm-6b çš„å±€é™æ€§å…·ä½“ä½“ç°åœ¨å“ªé‡Œï¼Œå¦‚ä½•å®ç°æ”¹è¿›`ä¸ºä¾‹

æœªä½¿ç”¨ langchain æ¥å…¥æœ¬åœ°æ–‡æ¡£æ—¶ï¼š

>ChatGLM-6B æ˜¯ä¸€ä¸ªåŸºäº GPT-3 çš„èŠå¤©æœºå™¨äºº,å®ƒçš„å±€é™æ€§ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢:
>1. è¯­è¨€æ¨¡å‹çš„ç²¾åº¦:GPT-3 æ˜¯ä¸€ç§å¤§å‹çš„è¯­è¨€æ¨¡å‹,å®ƒçš„ç²¾åº¦æ¯”è¾ƒé«˜,ä½†æ˜¯ä»ç„¶æœ‰ä¸€äº›å±€é™æ€§ã€‚ä¾‹å¦‚,å®ƒå¯èƒ½æ— æ³•å‡†ç¡®åœ°ç†è§£æŸäº›æ–¹è¨€ã€å£éŸ³æˆ–è€…å¤æ‚çš„å¥å­ç»“æ„ã€‚
>2. çŸ¥è¯†å›¾è°±çš„å®Œæ•´æ€§:GPT-3 å¯ä»¥ç”Ÿæˆä¸€äº›çŸ¥è¯†å›¾è°±,ä½†æ˜¯å…¶å®Œæ•´æ€§å’Œå‡†ç¡®æ€§å¯èƒ½ä¸å¤Ÿã€‚ä¾‹å¦‚,å®ƒå¯èƒ½æ— æ³•å‡†ç¡®åœ°ç†è§£æŸäº›é¢†åŸŸçš„ä¸“ä¸šçŸ¥è¯†å’Œæœ¯è¯­ã€‚
>3. å¯¹è¯ç”Ÿæˆçš„è¿è´¯æ€§:GPT-3 å¯ä»¥ç”Ÿæˆä¸€äº›è¿è´¯çš„å¯¹è¯,ä½†æ˜¯å…¶ç”Ÿæˆçš„å¯¹è¯å¯èƒ½ä¸å¤Ÿè‡ªç„¶ã€‚ä¾‹å¦‚,å®ƒå¯èƒ½ä¼šç”Ÿæˆä¸€äº›è™šå‡çš„ã€ä¸è¿è´¯çš„å¯¹è¯æˆ–è€…è¯¯è§£ç”¨æˆ·çš„æ„å›¾ã€‚
>
>ä¸ºäº†æ”¹è¿› ChatGLM-6B,å¯ä»¥è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªæ–¹é¢:
>1. æé«˜è¯­è¨€æ¨¡å‹çš„ç²¾åº¦:å¯ä»¥é€šè¿‡å¢åŠ è®­ç»ƒæ•°æ®ã€ä½¿ç”¨æ›´å¥½çš„è¯­è¨€æ¨¡å‹æ¶æ„ã€ä¼˜åŒ–æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ç­‰æ–¹å¼æ¥æé«˜è¯­è¨€æ¨¡å‹çš„ç²¾åº¦ã€‚
>2. å¢å¼ºçŸ¥è¯†å›¾è°±çš„å®Œæ•´æ€§:å¯ä»¥é€šè¿‡å¢åŠ çŸ¥è¯†å›¾è°±çš„ç»´åº¦ã€ä½¿ç”¨æ›´å¥½çš„çŸ¥è¯†å›¾è°±æ„å»ºæ–¹æ³•ã€ä¼˜åŒ–çŸ¥è¯†å›¾è°±çš„åŒ¹é…ç®—æ³•ç­‰æ–¹å¼æ¥å¢å¼ºçŸ¥è¯†å›¾è°±çš„å®Œæ•´æ€§ã€‚
>3. æé«˜å¯¹è¯ç”Ÿæˆçš„è¿è´¯æ€§:å¯ä»¥é€šè¿‡å¢åŠ å¯¹è¯ç”Ÿæˆæ¨¡å‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€ä½¿ç”¨æ›´å¥½çš„ä¸Šä¸‹æ–‡ä¿¡æ¯æå–æ–¹æ³•ã€ä¼˜åŒ–å¯¹è¯ç”Ÿæˆæ¨¡å‹çš„ç®—æ³•ç­‰æ–¹å¼æ¥æé«˜å¯¹è¯ç”Ÿæˆçš„è¿è´¯æ€§ã€‚
>4. å¼•å…¥æ›´å¤šçš„äººç±»åé¦ˆ:äººç±»åé¦ˆå¯ä»¥å¸®åŠ© ChatGLM-6B æ›´å¥½åœ°ç†è§£ç”¨æˆ·çš„æ„å›¾å’Œéœ€æ±‚,ä»è€Œæé«˜å¯¹è¯ç”Ÿæˆçš„è´¨é‡å’Œå‡†ç¡®æ€§ã€‚å¯ä»¥é€šè¿‡å¼•å…¥æ›´å¤šçš„äººç±»å®¢æœã€ä½¿ç”¨äººç±»åé¦ˆæ”¶é›†å™¨ç­‰æ–¹å¼æ¥å¼•å…¥æ›´å¤šçš„äººç±»åé¦ˆã€‚

ä½¿ç”¨ langchain æ¥å…¥ ChatGLM-6B é¡¹ç›®çš„ README.md æ–‡ä»¶å ChatGLM çš„å›ç­”ï¼š
>ChatGLM-6B æ˜¯ä¸€ä¸ªåŸºäºæ·±åº¦å­¦ä¹ çš„è‡ªç„¶è¯­è¨€å¤„ç†æ¨¡å‹,å®ƒåœ¨å›ç­”é—®é¢˜æ–¹é¢è¡¨ç°å‡ºè‰²ã€‚ä½†æ˜¯,å®ƒä¹Ÿæœ‰ä¸€äº›å±€é™æ€§,å…·ä½“å¦‚ä¸‹:
>1. è¯­è¨€ç†è§£æœ‰é™:ChatGLM-6B åªå­¦ä¹ äº†ä¸­æ–‡è‡ªç„¶è¯­è¨€,å¯¹äºå…¶ä»–è¯­è¨€å¯èƒ½ä¼šå­˜åœ¨ç†è§£ä¸Šçš„å±€é™æ€§ã€‚
>2. çŸ¥è¯†å‚¨å¤‡ä¸è¶³:ChatGLM-6B çš„è®­ç»ƒæ•°æ®é›†åªåŒ…å«äº†ä¸­æ–‡è¯­æ–™,å› æ­¤å®ƒå¯èƒ½æ— æ³•å›ç­”ä¸€äº›éä¸­æ–‡çš„é—®é¢˜æˆ–è€…æŸäº›ç‰¹å®šé¢†åŸŸçš„é—®é¢˜ã€‚
>3. æ•°æ®é‡æœ‰é™:ChatGLM-6B çš„è®­ç»ƒæ•°æ®é›†åªæœ‰å‡ ç™¾ä¸‡æ¡è®°å½•,å› æ­¤å®ƒå¯èƒ½æ— æ³•å›ç­”ä¸€äº›éå¸¸å…·ä½“æˆ–è€…å¤æ‚çš„é—®é¢˜ã€‚
>
>ä¸ºäº†æ”¹è¿› ChatGLM-6B,å¯ä»¥è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªæ–¹é¢:
>1. å­¦ä¹ æ›´å¤šçš„è¯­è¨€çŸ¥è¯†:å¯ä»¥å­¦ä¹ å…¶ä»–è¯­è¨€çš„è‡ªç„¶è¯­è¨€å¤„ç†æŠ€æœ¯,æ‰©å¤§è¯­è¨€ç†è§£çš„èŒƒå›´ã€‚
>2. æ‰©å¤§çŸ¥è¯†å‚¨å¤‡:å¯ä»¥æ”¶é›†æ›´å¤šçš„ä¸­æ–‡è¯­æ–™,æˆ–è€…ä½¿ç”¨å…¶ä»–è¯­è¨€çš„æ•°æ®é›†æ¥æ‰©å……çŸ¥è¯†å‚¨å¤‡ã€‚
>3. å¢åŠ æ•°æ®é‡:å¯ä»¥ä½¿ç”¨æ›´å¤§çš„æ•°æ®é›†æ¥è®­ç»ƒ ChatGLM-6B,æé«˜æ¨¡å‹çš„è¡¨ç°ã€‚
>4. å¼•å…¥æ›´å¤šçš„è¯„ä¼°æŒ‡æ ‡:å¯ä»¥å¼•å…¥æ›´å¤šçš„è¯„ä¼°æŒ‡æ ‡æ¥è¯„ä¼°æ¨¡å‹çš„è¡¨ç°,ä»è€Œå‘ç° ChatGLM-6B å­˜åœ¨çš„ä¸è¶³å’Œå±€é™æ€§ã€‚
>5. æ”¹è¿›æ¨¡å‹æ¶æ„:å¯ä»¥æ”¹è¿› ChatGLM-6B çš„æ¨¡å‹æ¶æ„,æé«˜æ¨¡å‹çš„æ€§èƒ½å’Œè¡¨ç°ã€‚ä¾‹å¦‚,å¯ä»¥ä½¿ç”¨æ›´å¤§çš„ç¥ç»ç½‘ç»œæˆ–è€…æ”¹è¿›çš„å·ç§¯ç¥ç»ç½‘ç»œç»“æ„ã€‚

## è·¯çº¿å›¾
- [x] å®ç° langchain + ChatGLM-6B æœ¬åœ°çŸ¥è¯†åº”ç”¨
- [x] åŸºäº langchain å®ç°éç»“æ„åŒ–æ–‡ä»¶æ¥å…¥
- [ ] åŸºäº langchain å®ç°æ›´å¤šç±»å‹æœ¬åœ°çŸ¥è¯†æ–‡ä»¶æ¥å…¥
- [ ] å¢åŠ  Web UI DEMO
  - [x] åˆ©ç”¨ gradio å®ç° Web UI DEMO
  - [ ] æ·»åŠ æ¨¡å‹åŠ è½½è¿›åº¦æ¡
  - [ ] æ·»åŠ è¾“å‡ºå†…å®¹åŠé”™è¯¯æç¤º
  - [ ] å›½é™…åŒ–è¯­è¨€åˆ‡æ¢
  - [ ] å¼•ç”¨æ ‡æ³¨
  - [ ] æ·»åŠ æ’ä»¶ç³»ç»Ÿï¼ˆå¯åŸºç¡€loraè®­ç»ƒç­‰ï¼‰
- [ ] åˆ©ç”¨ fastapi å®ç° API éƒ¨ç½²æ–¹å¼ï¼Œå¹¶å®ç°è°ƒç”¨ API çš„ web ui DEMO

## é¡¹ç›®äº¤æµç¾¤
![ç¾¤èŠäºŒç»´ç ](img/group_qr_code.jpg)
ğŸ‰ langchain-ChatGLM é¡¹ç›®äº¤æµç¾¤ï¼Œå¦‚æœä½ ä¹Ÿå¯¹æœ¬é¡¹ç›®æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥ç¾¤èŠå‚ä¸è®¨è®ºäº¤æµã€‚
