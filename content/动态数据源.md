---
author: 技术平台部
---
# 动态数据源


> 提供动态数据源，适用于多数据源场景下，可通过注解或编程式切换当前数据源，对于数据源表中配置的数据源同样可进行切换（详见Metadata章节说明）

## 1. pom依赖

框架核心包已经默认集成动态数据源，使用时无需再引包，如需使用dacm或者bigdata的数据，需额外引包

* 注：bigdata功能目前还未实现

### 1.1 dacm

#### 1.1.1 引包
```
<dependency>
    <groupId>com.dragonsoft</groupId>
    <artifactId>duceap-adapter-dacm-metadata</artifactId>
</dependency>
```

#### 1.1.2 配置dacm数据源信息
```
#dacm 过渡阶段数据源配置
duceap.dacm.datasource.url=jdbc\:oracle\:thin\:@192.168.0.216\:1521\:orcl
duceap.dacm.datasource.username=dacm_v3
duceap.dacm.datasource.password=dragon
```

### 1.2 bigdata
```
<dependency>
    <groupId>com.dragonsoft</groupId>
    <artifactId>duceap-adapter-bigdata-metadata</artifactId>
</dependency>
```


## 2. 多数据源配置

```
#通过配置duceap.datasource.dynamic.{dataSourceName}.{dataSourceProp}，将自动启用多数据源

duceap.datasource.dynamic.gp.url = jdbc:pivotal:greenplum://192.168.120.132:5432;DatabaseName=jz
duceap.datasource.dynamic.gp.username =gpadmin
duceap.datasource.dynamic.gp.password =gpadmin
duceap.datasource.dynamic.gp.driver-class-name=com.pivotal.jdbc.GreenplumDriver

duceap.datasource.dynamic.gp2.url = jdbc:pivotal:greenplum://192.168.120.132:5432;DatabaseName=jz
duceap.datasource.dynamic.gp2.username =gpadmin2
duceap.datasource.dynamic.gp2.password =gpadmin2
duceap.datasource.dynamic.gp2.driver-class-name=com.pivotal.jdbc.GreenplumDriver
```

> 通过数据源ID指定动态数据源（如果不是给指定数据源ID取别名，建议不要配置，直接使用T_MD_DATASOURCE表中的datasource_id指定数据源即可）

```
#全局配置，指定所有{datasourceId} 数据来源，支持dacm|database|bigdata，默认优先级bigdata>dacm>database
duceap.metadata.provider=database

#局部配置，指定单个{dataSourceName}的数据来源，只对当前{dataSourceName}有效
#datasourceType为 database|bigdata|dacm  默认优先级bigdata>dacm>database
#duceap.datasource.dynamic.{dataSourceName}.datasourceType={datasourceType}
duceap.datasource.dynamic.ddas.datasourceType=dacm

#指定{datasourceId}, 当{datasourceType}为database时，{datasourceId}对应 本地数据库T_MD_DATASOURCE表中的datasource_id
#duceap.datasource.dynamic.{dataSourceName}.datasourceId={datasourceId}
duceap.datasource.dynamic.ddas.datasourceId=ddasid

```

注意：

```
1：可以通过 duceap.metadata.provider=database 全局配置 指定全局的数据来源

2：或者通过duceap.datasource.dynamic.{dataSourceName}.datasourceType局部配置 为单个{dataSourceName}指定单独的数据来源

3：局部配置优先级大于全局配置,当局部配置和全局配置同时存在时局部配置会覆盖全局配置

4：动态数据源表(T_MD_DATASOURCE)中配置的数据源初始化会将所有配置加载，也可以使用T_MD_DATASOURCE表中的datasource_id直接切换数据源，无需再在配置文件中通过数据源ID指定动态数据源

5：{dataSourceName}只支持字母、数字、横杠、下换线组合，且不能以横杠或下划线开头
```

* 注意：当需要使用到本地数据库T_MD_DATASOURCE表配置的数据源信息时，需要引入元数据组件包,自动建表

```
<dependency>
    <groupId>com.dragonsoft</groupId>
    <artifactId>duceap-boot-starter-metadata</artifactId>
</dependency>
```

数据源表配置详见Metadata章节

## 3. 动态数据源切换

### 3.1 @TargetDataSource注解

- 采用@TargetDataSource注解切换,可配置于类或方法上，不配置情况下采用默认数据源。@TargetDataSource建议都注解在Service层
- 注解的值为配置的{dataSourceName}
- 当注解的{dataSourceName}数据源不存在时，则使用系统默认数据源

```
@Service
@Transactional
@TargetDataSource("gp")
public class UserInfoService extends BaseService<UserInfo, String> implements IUserInfoService {

    public List<UserInfo> findUserInfoByName(String sql) {
        return PersistentFactory.getJdbcDao().queryForList(sql);
    }
}
```


```
@Service
@Transactional
public class UserInfoService extends BaseService<UserInfo, String> implements IUserInfoService {
    @TargetDataSource("gp")
    public List<UserInfo> findUserInfoByName(String sql) {
        return PersistentFactory.getJdbcDao().queryForList(sql);
    }
}
```

**注意：当在有事务注解情况下，Spring A Service调用Spring B Service，且两个方法分别注解了不同动态数据源，此时B Service的@TargetDataSource注解将不会生效，即拿到也是A Service的数据源。**

### 3.2 通过编程式切换

 - 利用DynamicDataSourceHolder.setDataSourceType("ddas")方式显示的切换数据源，其中dataSourceType的值为配置的{dataSourceName}
 - 该方式会修改到默认的动态数据源，因此使用后须使用DynamicDataSourceHolder.clearDataSourceType()重置数据源
 - 当{dataSourceName}的数据源不存在时，则使用系统默认数据源

```
        //设置动态数据源
        DynamicDataSourceHolder.setDataSourceType("ddas");
        jdbcTemplate.*******数据库操作****
        //重置数据源
        DynamicDataSourceHolder.clearDataSourceType();
```

**注意：该方式不支持在带@Transactional事务注解的方法下使用。**

**三种方式同时存在时优先级顺序：编程式切换>@TargetDataSource方法级注解>@TargetDataSource类级注解**

## 4.PersistentFactory获取指定数据源dao

通过指定dataSourceName获取jdbcDao,可以对指定数据源进行jdbc操作

```
IBaseDAOJdbc jdbcDao=PersistentFactory.getJdbcDao(dataSourceName);
```

## 5.DataSourceUtils介绍

   提供DataSourceUtils工具类，提供了缓存获取、刷新、构建等方法，具体详见java doc章节

## 6.支持Druid连接池

> Spring默认支持com.zaxxer.hikari.HikariDataSource、org.apache.tomcat.jdbc.pool.DataSource、org.apache.commons.dbcp2.BasicDataSource几种连接池，且默认引入Hikari连接池

> 平台扩展druid连接池支持，只需引入duceap-boot-starter-druid包即可

```
    <dependency>
        <groupId>com.dragonsoft</groupId>
        <artifactId>duceap-boot-starter-druid</artifactId>
    </dependency>
```


## 7.注意事项

1：动态数据源和主数据源如果是不同的数据库类型，请使用jdbcTemplate进行操作，而不是jpa，否则会因为数据库方言不一致而查询失败。因为目前不支持对每个动态数据源单独设置数据库方言，所以使用的是主数据库方言。

2：当使用jdbc查询的时候，可以通过DialectFactory.getDatabaseDialect(String dbType).buildPaginationSql(String originalSql, RowSelection rowSelection);来获取不同数据库的分页语句；使用com.dragonsoft.duceap.core.search.SqlGenerator 将searchable转换成sql
